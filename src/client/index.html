<!DOCTYPE html>
<html>
  <style>
    body {
      background-color: #122a4e;
    }
    h1, h2 {
      color:white;
    }
    a {
      border-style: solid;
      border-color: pink;
      border-width: 5px;
      border-radius: 10px;
      font-size: 50px;
      background-color: white;
      padding-top: 5px;
      padding-bottom: 5px;
      padding-left: 5px;
      padding-right: 5px;
    }
    img{
      width: 30%;
      height: 30%;
    }
    #home{
      position: static;
    }
    #characterCreator{
        /**display: none;*/
        position: absolute;
        background-color: #0b4b90;
        border: solid;
        border-width: 5px;
        border-color: #05336f;
        border-radius: 10px;
        height:500px;
        left: 10%;
        right: 10%;
    }
    #preview{
      position:absolute;
      background-color: pink;
      border: solid;
      border-width: 5px;
      right:5%;
      top:10%;
      bottom:30%;
      left:80%;
    }
    .pullout{
      display: none;
      position:absolute;
      background-color: #74b6dc;
      border: solid;
      border-width: 5px;
      border-color: #05336f;
      border-radius: 10px;
      right:21%;
      top:5%;
      bottom:10%;
      left:15%;
    }
    #genderPullout{
      display: block;
    }

    .button {
  display: inline-block;
  border-radius: 4px;
  background-color: #60d8c2;
  border: none;
  color: #FFFFFF;
  text-align: center;
  font-size: 50px;
  padding: 5px;
  width: 150px;
  transition: all 0.5s;
  cursor: pointer;
  margin: 5px;
}
.button.left{
  font-size: 25px;
  width: 100px;
}
.button.right{
  font-size: 25px;
  width: 100px;
}

.button span {
  cursor: pointer;
  display: inline-block;
  position: relative;
  transition: 0.5s;
}

  .button.left span:before {
    content: '\00AB';
    left: 20px;
  }
  .button.right span:before {
    content: '\00bb';
    right: -20px;
  }
  .button.main span:after {
    content: '\00bb';
    right: -20px;
  }

.button span:after {
  position: absolute;
  opacity: 0;
  top: 0;
  transition: 0.2s;
}

.button:hover span {
  padding-right: 25px;
}
.button.right:hover span {
  padding-left: 50px;
}

.button:hover span:after {
  opacity: 1;
  right: 0;
}
.button:active {
  background-color: #e5ecb4;
  box-shadow: 0 5px #666;
  transform: translateY(4px);
}
.container {
  position: absolute;

  height: 100%;
  right:0%;
  top:0%;
  bottom:0%;
  left:45%;
  display: flex;
  justify-content: center;
  align-items: center;
}
#color-picker {
  border: 3px solid rgba(15, 15, 15, 0.2);
}
.info {
  width: 12em;
  display: flex;
  margin-left: 4em;
  flex-direction: row;
  justify-content: space-between;
}
.selected {
  width: 50px;
  height: 50px;
  border-radius: 100%;
  border: 2px solid rgba(15, 15, 15, 0.2);
}


  </style>

  <body>
    <div id ="home">
      <center>
        <h1>TastyTails</h1>
        <h2>~Under Construction~</h2>
        <a href="gameindex.html">Click Here to play Alpha</a><br>
        <img src="assets/images/Tasty_Tails_under_construction.png" alt="Under Construction">
      </center>
    </div>
    <div id ="characterCreator">
      <div id="primaryButtons">
        <button id="gender" class="button main" style="vertical-align:middle"><span>&#9892; </span></button>
        <br>
        <button id="species" class="button main" style="vertical-align:middle"><span>Species </span></button>
        <br>
        <button id="about" class="button main" style="vertical-align:middle"><span>About </span></button>
      </div>

      <div id ="genderPullout" class="pullout">
        <div id ="bodyType">
          <button id="bodyLeft" class="button left" style="vertical-align:middle"><span> </span></button>
          Body Type Options
          <button id="bodyRight" class="button right" style="vertical-align:middle"><span> </span></button>
        </div>
        <div id ="genitailia">
          <button id="genitleLeft" class="button left" style="vertical-align:middle"><span> </span></button>
          Genitailia Options
          <button id="genitleRight" class="button right" style="vertical-align:middle"><span> </span></button>
        </div>

      </div>
      <div id ="speciesPullout" class="pullout">
        <div class="container">
          <canvas id="color-picker"></canvas>
          <div class="info">
            <div class="selected"></div>
          </div>
        </div>
        <div id ="headType">
          <button id="headLeft" class="button left" style="vertical-align:middle"><span> </span></button>
          Head Type Options
          <button id="headRight" class="button right" style="vertical-align:middle"><span> </span></button>
        </div>
        <div id ="tailType">
          <button id="tailLeft" class="button left" style="vertical-align:middle"><span> </span></button>
          Tail Options
          <button id="tailRight" class="button right" style="vertical-align:middle"><span> </span></button>
        </div>
      </div>
      <div id ="aboutPullout" class="pullout">

      </div>

      <div id="preview">

      </div>
    </div>





    <script src="//cdn.jsdelivr.net/npm/phaser@3.13.0/dist/phaser.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <script>
      class Picker {
        constructor(target, width, height) {
          this.target = target;
          this.width = width;
          this.height = height;
          this.target.width = width;
          this.target.height = height;
          //Get context
          this.context = this.target.getContext("2d");
          //Circle
          this.pickerCircle = { x: 10, y: 10, width: 7, height: 7 };

          this.listenForEvents();
        }

        draw() {
          this.build();
        }

        build() {
          let gradient = this.context.createLinearGradient(0, 0, this.width, 0);

          //Color Stops
          gradient.addColorStop(0, "rgb(255, 0, 0)");
          gradient.addColorStop(0.15, "rgb(255, 0, 255)");
          gradient.addColorStop(0.33, "rgb(0, 0, 255)");
          gradient.addColorStop(0.49, "rgb(0, 255, 255)");
          gradient.addColorStop(0.67, "rgb(0, 255, 0)");
          gradient.addColorStop(0.84, "rgb(255, 255, 0)");
          gradient.addColorStop(1, "rgb(255, 0, 0)");
          //Fill it
          this.context.fillStyle = gradient;
          this.context.fillRect(0, 0, this.width, this.height);

          //Apply black & white
          gradient = this.context.createLinearGradient(0, 0, 0, this.height);
          gradient.addColorStop(0, "rgba(255, 255, 255, 1)");
          gradient.addColorStop(0.5, "rgba(255, 255, 255, 0)");
          gradient.addColorStop(0.5, "rgba(0, 0, 0, 0)");
          gradient.addColorStop(1, "rgba(0, 0, 0, 1)");
          this.context.fillStyle = gradient;
          this.context.fillRect(0, 0, this.width, this.height);

          //Circle
          this.context.beginPath();
          this.context.arc(this.pickerCircle.x, this.pickerCircle.y, this.pickerCircle.width, 0, Math.PI * 2);
          this.context.strokeStyle = "black";
          this.context.stroke();
          this.context.closePath();

        }
        listenForEvents() {
          let isMouseDown = false;
          const onMouseDown = (e) => {
            let currentX = e.clientX - this.target.offsetLeft;
            let currentY = e.clientY - this.target.offsetTop;

            console.log('currentX = ', currentX, '\n', 'currentY = ', currentY, '\n', 'e.clientX = ', e.clientX, '\n', 'e.clientY = ', e.clientY, '\n', 'this.target.offsetLeft = ', this.target.offsetLeft, '\n', 'this.target.offsetTop = ', this.target.offsetTop);
            if(currentY > this.pickerCircle.y && currentY < this.pickerCircle.y + this.pickerCircle.width && currentX > this.pickerCircle.x && currentX < this.pickerCircle.x + this.pickerCircle.width) {
              isMouseDown = true;
            } else {
              this.pickerCircle.x = currentX;
              this.pickerCircle.y = currentY;
            }
          }
          const onMouseMove = (e) => {
            if (isMouseDown) {
              let currentX = e.clientX - this.target.offsetLeft;
              let currentY = e.clientY - this.target.offsetTop;
              this.pickerCircle.x = currentX;
              this.pickerCircle.y = currentY;
            }
          }
          const onMouseUp = () => {
            isMouseDown = false;
          }
          //Register
          this.target.addEventListener("mousedown", onMouseDown);
          this.target.addEventListener("mousemove", onMouseMove);
          this.target.addEventListener("mousemove", () => this.onChangeCallback(this.getPickedColor()));
          document.addEventListener("mouseup", onMouseUp);

          getPickedColor() {
            let imageData = this.context.getImageData(this.pickerCircle.x, pickerCircle.y, 1, 1);
              return {r: imageData.data[0], g: imageData.data[1], b: imageData.data[2] };
          }
          onChange(callback) {
            this.onchangeCallback = Callback;
          }
        }
      }
      let picker = new Picker(document.getElementById("color-picker"), 250, 220);
      //draw
      setInterval(() => picker.draw(), 1);
      pickere((color) => {
        let selected = document.getElementByClassName("selected")[0];
          selected.style.backgroundColor = 'rgb(${color.r}, ${color.g}, {color.b})';
      })

      gender.addEventListener("click", function() {
        console.log('gender clicked');
        document.getElementById("genderPullout").style.display = "block";
        document.getElementById("speciesPullout").style.display = "none";
        document.getElementById("aboutPullout").style.display = "none";
        //document.getElementById("genderPullout").style.transform = translateX(50px);
      });
      species.addEventListener("click", function() {
        console.log('species clicked');
        document.getElementById("genderPullout").style.display = "none";
        document.getElementById("speciesPullout").style.display = "block";
        document.getElementById("aboutPullout").style.display = "none";
      });
      about.addEventListener("click", function() {
        console.log('about clicked');
        document.getElementById("genderPullout").style.display = "none";
        document.getElementById("speciesPullout").style.display = "none";
        document.getElementById("aboutPullout").style.display = "block";
      });
      bodyLeft.addEventListener("click", function() {
        console.log('bodyLeft clicked');
        if (bodySelection > 1) {
          console.log('bodySelection is greater than 1');
          bodySelection = bodySelection - 1;
          console.log('setting bodySelection to: ', bodySelection);
        }
      });
      bodyRight.addEventListener("click", function() {
        console.log('bodyRight clicked');
        if (bodySelection < 2) {
          console.log('bodySelection is less than 1');
          bodySelection = bodySelection + 1;
          console.log('setting bodySelection to: ', bodySelection);
        }
      });
      genitleLeft.addEventListener("click", function() {
        console.log('genitleLeft clicked');
        if (genitleSelection > 1) {
          genitleSelection = genitleSelection - 1;
          console.log('setting genitleSelection to: ', genitleSelection);
        } else {
          console.log('genitleSelection = 1 restarting');
          genitleSelection = 3;
          console.log('setting genitleSelection to: ', genitleSelection);
        }
      });
      genitleRight.addEventListener("click", function() {
        console.log('genitleRight clicked');
        if (genitleSelection < 3) {
          genitleSelection = genitleSelection + 1;
          console.log('setting genitleSelection to: ', genitleSelection);
        } else {
          console.log('genitleSelection = 3 restarting');
          genitleSelection = 1;
          console.log('setting genitleSelection to: ', genitleSelection);
        }
      });

      var bodySelection = 1;
      var genitleSelection = 1;
      var headSelection = 1;
      console.log('bodySelection = ', bodySelection);
      console.log('genitleSelection = ', genitleSelection);
      var config = {
        type: Phaser.AUTO,
        parent: 'preview',
        width: 200,
        height: 200,
        physics: {
          default: 'arcade',
          arcade: {
            debug: true,
            gravity: { y: 0 }
          }
        },
        scene: {
          preload: preload,
          create: create,
          update: update
        }
      };

      var game = new Phaser.Game(config);
      var localPlayerInfo = {Identifier:'', playerId:'', Username:'', Description:'', head:'head_01', headColor:'', body:'body_01', bodyColor:'', tail:'tail_01', eyes:'eyes_01', specialList:[], spellInventory:[],
      consumedBy:''};

      function preload() {
        this.load.spritesheet('testBody', 'assets/spritesheets/testBody.png', {frameWidth: 109, frameHeight: 220});
        this.load.spritesheet('head_01', 'assets/spritesheets/head_01.png', {frameWidth: 182, frameHeight: 190});
        this.load.spritesheet('head_02', 'assets/spritesheets/head_02.png', {frameWidth: 182, frameHeight: 190});
        this.load.spritesheet('head_03', 'assets/spritesheets/head_03.png', {frameWidth: 182, frameHeight: 190});
        this.load.spritesheet('body_01', 'assets/spritesheets/body_01.png', {frameWidth: 182, frameHeight: 190});
        this.load.spritesheet('tail_01', 'assets/spritesheets/tail_01.png', {frameWidth: 182, frameHeight: 190});
        this.load.spritesheet('eyes_01', 'assets/spritesheets/eyes_01.png', {frameWidth: 182, frameHeight: 190});
      }

      function create() {
        var self = this;
        this.socket = io();
        this.otherPlayers = this.physics.add.group();
        cursors = this.input.keyboard.createCursorKeys();
        //console.log('self.socket = ', self.socket);
        this.socket.on('currentPlayers', function (players, spells) {
          Object.keys(players).forEach(function (id) {
            console.log('Local players socket Id = ', players[id].playerId);
            if (players[id].playerId === self.socket.id) {
              console.log('players[id] = ', players[id]);
              addPlayer(self, players[id]);
            } else {
              return;
            }
          });
        });
        headRight.addEventListener("click", function() {
          console.log('headRight clicked');
          if (headSelection < 3) {
            headSelection = headSelection + 1;
            headfunct(self, headSelection);
          } else {
            headSelection = 1;
            headfunct(self, headSelection);
          }
        });
        headLeft.addEventListener("click", function() {
          console.log('headRight clicked');
          if (headSelection > 1) {
            headSelection = headSelection - 1;
            headfunct(self, headSelection);
          } else {
            headSelection = 3;
            headfunct(self, headSelection);
          }
        });
        function headfunct(self, headSelection) {
          if (headSelection == 1) {
            localPlayerInfo.head = 'head_01';
          }
          if (headSelection == 2) {
            localPlayerInfo.head = 'head_02';
          }
          if (headSelection == 3) {
            localPlayerInfo.head = 'head_03';
          }
          self.socket.emit('characterUpdate', localPlayerInfo);
        }


        this.socket.on('characterUpdated', function (playerInfo) {
          //console.log('characterUpdated', '\n', 'playerInfo.playerId = ', playerInfo.playerId, '\n', 'self.socket.id = ', self.socket.id);
            if (playerInfo.playerId === self.socket.id) {
              //addOtherPlayers(self, playerInfo);
              console.log(playerInfo.playerId, 'Called new animation successfully: ', '\n', 'Set head to: ', playerInfo.head, '\n', 'Set body to: ', playerInfo.body, '\n', 'Set Tail to:', playerInfo.tail,  '\n', 'Set eyes to:', playerInfo.eyes);
              self.head.play(playerInfo.head + 'Down');
              self.body.play(playerInfo.body + 'Down');
              self.tail.play(playerInfo.tail + 'Down');
              self.eyes.play(playerInfo.eyes + 'Down');

              //console.log('Head: ', self.head.anims.nextTick, '\n', 'Body: ', self.body.anims.nextTick, '\n', 'Tail: ', self.tail.anims.nextTick, '\n', 'Eyes: ', self.eyes.anims.nextTick);
              return;
            }
        });


        function addPlayer(self, playerInfo) {
          //self.stack = self.add.sprite(0, 0, 'body_01');
          //self.stack.visible = false;
          //self.stack.play('bodyDown');


          console.log('player head = ', playerInfo.head);
          self.container = self.add.container(0, 0).setInteractive();
          self.head = self.physics.add.sprite(0, 0, playerInfo.head).setInteractive();
          //head.setTint(playerInfo.headColor);
          self.body = self.physics.add.sprite(0, 0, playerInfo.body).setInteractive();
          //body.setTint(playerInfo.bodyColor);
          self.tail = self.physics.add.sprite(0, 0, playerInfo.tail).setInteractive();
          //tail.setTint(playerInfo.bodyColor);
          self.eyes = self.physics.add.sprite(0, 0, playerInfo.eyes).setInteractive();
          //eyes.setTint(playerInfo.bodyColor);
          self.container.add([ self.head, self.body, self.tail, self.eyes ]);
          //self.container.visible = false;
          self.head.play('head_01Down');
          self.body.play('body_01Down');
          self.tail.play('tail_01Down');
          self.eyes.play('eyes_01Down');


          localPlayerInfo.playerId = playerInfo.playerId;
          //localPlayerInfo.sprite = self.stack
          let cam1 = self.cameras.main.setSize(200, 200).startFollow(self.container).setName('Camera 1');


        }
        self.anims.create({
          key: 'head_01Down',
          frames: self.anims.generateFrameNumbers('head_01', { start: 1, end: 8 }),
          frameRate: 9,
          repeat: -1,
          showOnStart: true
        });
        self.anims.create({
          key: 'head_01Stop',
          frames: self.anims.generateFrameNumbers('head_01', { start: 0, end: 0 }),
          frameRate: 9,
          repeat: -1,
        });
        self.anims.create({
          key: 'head_02Down',
          frames: self.anims.generateFrameNumbers('head_02', { start: 1, end: 8 }),
          frameRate: 9,
          repeat: -1,
          showOnStart: true
        });
        self.anims.create({
          key: 'head_02Stop',
          frames: self.anims.generateFrameNumbers('head_01', { start: 0, end: 0 }),
          frameRate: 9,
          repeat: -1,
        });
        self.anims.create({
          key: 'head_03Down',
          frames: self.anims.generateFrameNumbers('head_03', { start: 1, end: 8 }),
          frameRate: 9,
          repeat: -1,
          showOnStart: true
        });
        self.anims.create({
          key: 'head_03Stop',
          frames: self.anims.generateFrameNumbers('head_01', { start: 0, end: 0 }),
          frameRate: 9,
          repeat: -1,
        });
        self.anims.create({
          key: 'body_01Down',
          frames: self.anims.generateFrameNumbers('body_01', { start: 1, end: 8 }),
          frameRate: 9,
          repeat: -1,
          showOnStart: true
        });
        self.anims.create({
          key: 'body_01Stop',
          frames: self.anims.generateFrameNumbers('head_01', { start: 0, end: 0 }),
          frameRate: 9,
          repeat: -1,
        });
        self.anims.create({
          key: 'tail_01Down',
          frames: self.anims.generateFrameNumbers('tail_01', { start: 1, end: 8 }),
          frameRate: 9,
          repeat: -1,
          showOnStart: true
        });
        self.anims.create({
          key: 'eyes_01Down',
          frames: self.anims.generateFrameNumbers('eyes_01', { start: 1, end: 8 }),
          frameRate: 9,
          repeat: -1,
          showOnStart: true
        });
      }


      function update() {
        if (cursors.down.isDown) {
          this.head.anims.stop();
          this.body.anims.stop();
          this.tail.anims.stop();
          this.eyes.anims.stop();
        }
        if (cursors.up.isDown) {
          this.head.play(localPlayerInfo.head + 'Down');
          this.body.play(localPlayerInfo.body + 'Down');
          this.tail.play(localPlayerInfo.tail + 'Down');
          this.eyes.play(localPlayerInfo.eyes + 'Down');
        }
      }
    </script>

  </body>
</html>

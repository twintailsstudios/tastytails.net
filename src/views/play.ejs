<head>
  <meta charset="UTF-8">
  <title>TastyTails | Play</title>

  <link rel="stylesheet" type="text/css" href="/css/play.css?v=<%= Date.now() %>" />

  <link rel="stylesheet" type="text/css" href="/css/chat.css" />
  <link rel="stylesheet" type="text/css" href="/css/contextMenu.css" />

  <!-- Typography -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Caveat+Brush&family=Cinzel:wght@400;700&family=Lato:ital,wght@0,400;0,700;1,400&display=swap"
    rel="stylesheet">

  <!-- Icons & Tools -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/classic.min.css">
</head>


<div id="navToggle" class="nav-toggle-btn" onclick="toggleNav()">
  <i class="fa-solid fa-bars"></i>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.body.classList.add('play-mode');
  });

  function toggleNav() {
    document.body.classList.toggle('nav-visible');
    const btnIcon = document.querySelector('#navToggle i');
    if (document.body.classList.contains('nav-visible')) {
      btnIcon.classList.remove('fa-bars');
      btnIcon.classList.add('fa-xmark');
    } else {
      btnIcon.classList.remove('fa-xmark');
      btnIcon.classList.add('fa-bars');
    }
  }
</script>

<div id="game-wrapper">
  <div id="phaserApp" tabindex="0" oncontextmenu="return showContextMenu(event);">
    <%- include('partials/gameOverlay') %>
      <div id="debug-overlay"
        style="display: none; position: absolute; top: 10px; right: 40px; z-index: 10000; pointer-events: none; font-family: Arial; font-weight: bold; text-shadow: 1px 1px 0 #000;">
        <div style="margin-bottom: 5px;">
          <div id="debug-rtt" style="color: #00ff00;">RTT: -</div>
          <div id="debug-dist" style="color: #ff0000;">Dist: -</div>
        </div>
        <div style="position: relative;">
          <canvas id="debug-graph" width="200" height="100" style="border: 1px solid #fff;"></canvas>
          <!-- Axis Labels -->
          <div
            style="position: absolute; left: -25px; top: 0; height: 100%; display: flex; flex-direction: column; justify-content: space-between; font-size: 10px; color: #00ff00; text-align: right; width: 20px;">
            <span>200</span><span>160</span><span>120</span><span>80</span><span>40</span><span>0</span>
          </div>
          <div
            style="position: absolute; right: -20px; top: 0; height: 100%; display: flex; flex-direction: column; justify-content: space-between; font-size: 10px; color: #ff0000; width: 20px;">
            <span>50</span><span>40</span><span>30</span><span>20</span><span>10</span><span>0</span>
          </div>
        </div>
      </div>
  </div>

  <div id="sidePanel">

    <%- include('partials/menu') %>

      <%- include('partials/chat') %>

  </div>
</div>

<!--Right Click Custom Menu (Moved to body to avoid clipping)-->
<div id="contextMenu" class="context-menu">
  <div class="normalMenu">
    <ul>
    </ul>
  </div>

  <div id="voreMenu" onmouseover="return specialTestFunction(event);" onmouseout="return specialMouseOut(event)">
    <ul id="voreMenuUl">
    </ul>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<!-- <script type="module" src="/js/index.js"></script> -->
<script src="/js/chat.js"></script>
<script src="/js/contextMenu.js"></script>
<!-- <script type="module">
    const serverPlayerInfo = <% charList %>
    console.log('serverPlayerInfo = ', serverPlayerInfo);
    export serverPlayerInfo;
  </script> -->
<!--Checks if the game is focused or the chat is focused-->
<script>
  var chatFocused = true;

  var avatarSelected = false;

  let avatarInfo = {
    head: "emptyplayer",
    body: "emptyplayer"
  };

  var rawCharList = `<%- JSON.stringify(charList)
    .replace(/\\/g, '\\\\')
    .replace(/'/g, '\\\'')
    .replace(/"/g, '&quot;')
    .replace(/\n/g, '\\n')
    .replace(/\r/g, '\\r')
    .replace(/\u2028/g, '\\u2028')
    .replace(/\u2029/g, '\\u2029') %>`;
  var charList = JSON.parse(rawCharList.replace(/&quot;/g, '"'));

  var localPlayerInfo = charList
  // localPlayerInfo.position.x = 3291;
  // localPlayerInfo.position.y = 4287;
  // localPlayerInfo.consumedBy = null;
  localPlayerInfo.rotation = 0;
  localPlayerInfo.isMoving = false;
  // localPlayerInfo.Identifier = "player";
  // localPlayerInfo.input = {
  //   left: false,
  //   right: false,
  //   up: false,
  //   down: false
  // };

  var currentIntent = 'friendly';
  document.querySelectorAll('input[name="intent"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      currentIntent = e.target.value;
      console.log('Intent changed to:', currentIntent);
    });
  });

  var voreTypes = [];
  var clicked = { Identifier: '' };
  var toDestroy = '';
  var container = null;
  var cam1 = null;
  var arrows = 0;

  // --- Focus Handling ---
  document.addEventListener('DOMContentLoaded', () => {
    const phaserApp = document.getElementById('phaserApp');
    const chatInput = document.getElementById('textarea');

    if (phaserApp) {
      phaserApp.setAttribute('tabindex', '0');
      phaserApp.addEventListener('click', () => {
        chatFocused = false;
        if (chatInput) chatInput.blur();
        phaserApp.focus();
        // console.log('Game Focused');
      });
      phaserApp.addEventListener('focus', () => {
        chatFocused = false;
        if (chatInput) chatInput.blur();
      });
    }

    if (chatInput) {
      chatInput.addEventListener('focus', () => {
        chatFocused = true;
        // console.log('Chat Focused');
      });
      chatInput.addEventListener('click', () => {
        chatFocused = true;
      });
    }
  });
</script>

<script type="module" src="/js/game/index.js"></script>
</section>
<!-- 
  === TYPOGRAPHY IMPORTS ===
  Cinzel: For Headers (Classic RPG feel)
  Lato: For UI elements and body text (Clean readability)
  Caveat Brush: For "Handwritten" character details (Immersion)
-->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
  href="https://fonts.googleapis.com/css2?family=Caveat+Brush&family=Cinzel:wght@400;700&family=Lato:ital,wght@0,400;0,700;1,400&display=swap"
  rel="stylesheet">

<!-- Icons (FontAwesome) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="/css/character-bank.css">

<!-- Main Content -->
<main>
  <div class="page-title">
    <h2>Character Registry</h2>
    <p>Select your persona to enter the world...</p>
  </div>

  <!-- The Container where JS will inject cards -->
  <div id="bankUl" class="character-grid">
    <!-- Cards go here -->
  </div>
</main>

<!-- DELETE CONFIRMATION MODAL -->
<!-- Note: This modal is shared by all delete actions to improve performance (DOM reuse) -->
<div id="deleteModal" class="modal-overlay">
  <div class="modal-box">
    <h2 id="modalTitle">Delete Character?</h2>
    <p>Are you sure you want to rip up this registration? Once they are gone, they cannot be summoned back.</p>

    <ul class="warning-list">
      <li>Character Looks & Design</li>
      <li>Written Biography</li>
      <li>Interaction Preferences</li>
      <li>All Custom Interactions</li>
    </ul>

    <div class="checkbox-container">
      <input type="checkbox" id="confirmDeleteCheck">
      <label for="confirmDeleteCheck">I understand this action is permanent and cannot be undone.</label>
    </div>

    <form id="deleteForm" method="POST" action="/api/user/deletecharacter/">
      <input type="hidden" name="charId" id="deleteInputId">
      <div class="modal-actions">
        <button type="button" class="btn-cancel" onclick="closeModal()">No, Keep Them</button>
        <button type="submit" id="finalDeleteBtn" class="btn-delete" disabled>Yes, Delete</button>
      </div>
    </form>
  </div>
</div>

<% if (charList !==null) { %>
  <script>
    /* ===========================================
       DATA & CONFIGURATION
       ===========================================
    */

    // Escape and parse the charList variable safely
    var rawCharList = `<%- JSON.stringify(charList)
    .replace(/\\/g, '\\\\')
    .replace(/'/g, '\\\'')
    .replace(/"/g, '&quot;')
    .replace(/\n/g, '\\n')
    .replace(/\r/g, '\\r')
    .replace(/\u2028/g, '\\u2028')
    .replace(/\u2029/g, '\\u2029') %>`;
    var charList = JSON.parse(rawCharList.replace(/&quot;/g, '"'));

    // DOM Elements
    const grid = document.getElementById('bankUl');
    const modal = document.getElementById('deleteModal');
    const modalTitle = document.getElementById('modalTitle');
    const deleteInputId = document.getElementById('deleteInputId');
    const confirmCheck = document.getElementById('confirmDeleteCheck');
    const finalDeleteBtn = document.getElementById('finalDeleteBtn');

    // Helper: Convert 0x hex to # hex for CSS
    function formatColor(hexString) {
      if (!hexString) return '#ccc';
      return hexString.replace('0x', '#');
    }

    // Helper: Map pronoun codes to strings
    function getPronouns(pCode) {
      if (pCode === 1) return "She/Her";
      if (pCode === 2) return "He/Him";
      if (pCode === 3) return "They/Them";
      return "Unknown";
    }

    /* ===========================================
       RENDER LOGIC
       ===========================================
       Generates the HTML for each card and injects it into the grid.
    */
    function renderCharacters() {
      grid.innerHTML = ''; // Clear existing content

      charList.forEach((char, index) => {
        const charId = char._id;
        const displayName = char.nickName || char.firstName || "Unknown";
        const fullName = (char.firstName && char.lastName) ? `${char.firstName} ${char.lastName}` : "Unknown Identity";
        const species = char.speciesName || "Unknown";
        const pronouns = getPronouns(char.pronouns);
        const desc = char.icDescrip || "No description provided.";
        const headColor = formatColor(char.head?.color);

        // Create Card Container
        const card = document.createElement('div');
        card.className = 'char-card';

        // Use Template Literal for readable HTML structure
        card.innerHTML = `
                <div class="card-header">
                    <div class="card-pin"></div>
                    <h3 class="nickname">${displayName}</h3>
                    <div class="fullname">${fullName}</div>
                    
                    <!-- Settings Gear Icon -->
                    <button class="card-options-btn" onclick="toggleMenu('${charId}')">
                        <i class="fa-solid fa-gear"></i>
                    </button>
                    
                    <!-- Context Menu (Hidden by default) -->
                    <div id="menu-${charId}" class="context-menu">
                        <ul>
                            <li><a href="#" onclick="openDeleteModal('${charId}', '${displayName}')"><i class="fa-solid fa-trash"></i> Delete</a></li>
                        </ul>
                    </div>
                </div>
                
                <div class="card-body">
                    <div class="species-badge">${species}</div>
                    
                    <!-- Avatar Placeholder: Uses data color for background -->
                    <div class="avatar-placeholder" style="background-color: ${headColor}">
                        <i class="fa-solid fa-paw"></i>
                    </div>
                    
                    <div class="stats">
                        <div class="stat-row">
                            <i class="fa-solid fa-venus-mars" style="font-size: 0.8rem; margin-top:3px;"></i> 
                            <span>${pronouns}</span>
                        </div>
                    </div>
                    <div class="description-preview">"${desc}"</div>
                </div>
                
                <div class="card-footer">
                    <a href="play/${charId}" class="btn btn-play"><i class="fa-solid fa-play"></i> Play</a>
                    <a href="edit/${charId}" class="btn btn-edit"><i class="fa-solid fa-pen-to-square"></i> Edit</a>
                </div>
            `;

        grid.appendChild(card);
      });

      // "Add New" Card (Always at the end)
      const addCard = document.createElement('a');
      addCard.href = "/create";
      addCard.className = "char-card add-card";
      addCard.innerHTML = `
            <div class="add-icon"><i class="fa-solid fa-circle-plus"></i></div>
            <div class="add-text">Register New</div>
        `;
      grid.appendChild(addCard);
    }

    /* ===========================================
       INTERACTION HANDLERS
       ===========================================
    */

    // Toggle the dropdown menu for a specific card
    window.toggleMenu = function (id) {
      const menu = document.getElementById(`menu-${id}`);
      // Safety: Close all other open menus first
      document.querySelectorAll('.context-menu').forEach(m => {
        if (m.id !== `menu-${id}`) m.classList.remove('visible');
      });
      menu.classList.toggle('visible');
    }

    // Global Click Listener: Close menus when clicking outside
    document.addEventListener('click', function (event) {
      if (!event.target.closest('.card-options-btn')) {
        document.querySelectorAll('.context-menu').forEach(m => m.classList.remove('visible'));
      }
    });

    // Open the shared Delete Modal
    window.openDeleteModal = function (id, name) {
      modalTitle.innerText = `Delete ${name}?`;
      deleteInputId.value = id; // Set the hidden input for the form

      // Reset modal state
      confirmCheck.checked = false;
      finalDeleteBtn.disabled = true;
      finalDeleteBtn.classList.remove('active');

      modal.classList.add('active');
    }

    // Close Modal
    window.closeModal = function () {
      modal.classList.remove('active');
    }

    // Enable Delete Button only when checkbox is checked
    confirmCheck.addEventListener('change', function () {
      if (this.checked) {
        finalDeleteBtn.disabled = false;
        finalDeleteBtn.classList.add('active');
      } else {
        finalDeleteBtn.disabled = true;
        finalDeleteBtn.classList.remove('active');
      }
    });

    // Initialize Page
    renderCharacters();

  </script>
  <% } else { %>
    <script>
      console.log('No current characters');
    </script>
    <% } %>